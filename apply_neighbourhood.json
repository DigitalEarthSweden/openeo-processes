{
    "id": "apply_neighbourhood",
    "summary": "Apply a process to pixels in a n-dimensional neighbourhood",
    "description": "Apply a focal process to a data cube. A focal process is a process that works on a 'neighbourhood' of pixels. The neighbourhood can extend into multiple dimensions. An overlap can be specified so that neighbourhoods can have overlapping boundaries. This allows for continuity of the output.\n\nThe process must not add new dimensions, or remove entire dimensions, but the result can use different dimension labels.\n\nFor the special case of 2D convolution, it is recommended to use ``apply_kernel()``.",
    "categories": [
        "cubes"
    ],
    "parameters": [
        {
            "name": "data",
            "description": "A data cube.",
            "schema": {
                "type": "object",
                "subtype": "raster-cube"
            }
        },
        {
            "name": "process",
            "description": "Process to be applied on all neighbourhoods.",
            "schema": {
                "type": "object",
                "subtype": "process-graph",
                "parameters": [
                    {
                        "name": "data",
                        "description": "A subset of the data cube as specified in `context` and `overlap`.",
                        "schema": {
                            "type": "object",
                            "subtype": "raster-cube"
                        }
                    },
                    {
                        "name": "context",
                        "description": "Additional data passed by the user.",
                        "schema": {
                            "description": "Any data type."
                        },
                        "optional": true,
                        "default": null
                    }
                ]
            }
        },
        {
            "name": "size",
            "description": "Neighbourhood sizes along each dimension.\nThis object maps dimension names to either a physical measure, (e.g. 100 m, 10 days), or pixels (e.g. 32 pixels).\nFor dimensions not specified, the default is to provide all values. This may result in an exception if the dimension is too large to be fully included.",
            "schema": {
                "type": "array",
                "items": {
                    "type": "object",
                    "subtype": "chunk-size",
                    "required": [
                        "dimension",
                        "value"
                    ],
                    "properties": {
                        "dimension": {
                            "type": "string"
                        },
                        "value": {
                            "default": null,
                            "oneOf": [
                                {
                                    "type": "null",
                                    "description": "All values"
                                },
                                {
                                    "type": "number",
                                    "minimum": 0,
                                    "description": "See the `unit` parameter for more information."
                                },
                                {
                                    "type": "string",
                                    "subtype": "duration",
                                    "description": "ISO 8601 duration, e.g. `P1D` for one day."
                                }
                            ]
                        },
                        "unit": {
                            "type": "string",
                            "description": "The unit the values are given in. If no unit is given, uses the unit specified for the dimension or if not given the default unit of the reference system.",
                            "enum": [
                                "px",
                                "m"
                            ]
                        }
                    }
                }
            }
        },
        {
            "name": "overlap",
            "description": "Overlap of chunks along each dimension. This allows neighbourhoods to overlap. For instance a temporal dimension can add 1 month before and after a neighbourhood. In the spatial dimensions, this is often a number of pixels. The overlap specified is added before and after, so an overlap of 8 pixels will add 8 pixels on both sides of the window, so 16 in total.\nModifying overlapping data in subsequent operations should have no effect.\nFor dimensions not specified, the default is to provide no overlap.",
            "optional": true,
            "schema": {
                "type": "array",
                "items": {
                    "type": "object",
                    "subtype": "chunk-size",
                    "required": [
                        "dimension",
                        "value"
                    ],
                    "properties": {
                        "dimension": {
                            "type": "string"
                        },
                        "value": {
                            "default": null,
                            "oneOf": [
                                {
                                    "type": "null",
                                    "description": "No values"
                                },
                                {
                                    "type": "number",
                                    "minimum": 0,
                                    "description": "See the `unit` parameter for more information."
                                },
                                {
                                    "type": "string",
                                    "subtype": "duration",
                                    "description": "ISO 8601 duration, e.g. `P1D` for one day."
                                }
                            ]
                        },
                        "unit": {
                            "type": "string",
                            "description": "The unit the values are given in. If no unit is given, uses the unit specified for the dimension or if not given the default unit of the reference system.",
                            "enum": [
                                "px",
                                "m"
                            ]
                        }
                    }
                }
            }
        },
        {
            "name": "context",
            "description": "Additional data to be passed to the process.",
            "schema": {
                "description": "Any data type."
            },
            "optional": true,
            "default": null
        }
    ],
    "returns": {
        "description": "A data cube with the newly computed values. The resolution and the number of dimensions are the same as for the original data cube.",
        "schema": {
            "type": "object",
            "subtype": "raster-cube"
        }
    },
    "examples": [
        {
            "arguments": {
                "data": {
                    "from_parameter": "data"
                },
                "process": {
                    "process_graph": {
                        "udf": {
                            "process_id": "run_udf",
                            "arguments": {
                                "data": {
                                    "from_parameter": "data"
                                },
                                "udf": "ml.py",
                                "runtime": "Python"
                            },
                            "result": true
                        }
                    }
                },
                "size": [
                    {
                        "dimension": "x",
                        "value": 128,
                        "unit": "px"
                    },
                    {
                        "dimension": "y",
                        "value": 128,
                        "unit": "px"
                    },
                    {
                        "dimension": "t",
                        "value": "P5D"
                    }
                ],
                "overlap": [
                    {
                        "dimension": "x",
                        "value": 16,
                        "unit": "px"
                    },
                    {
                        "dimension": "y",
                        "value": 16,
                        "unit": "px"
                    },
                    {
                        "dimension": "t",
                        "value": "P3D"
                    }
                ]
            }
        }
    ],
    "exceptions": {
        "DimensionNotAvailable": {
            "message": "A dimension with the specified name does not exist."
        }
    }
}